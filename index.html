<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Daugram Elite - Groups & Channels</title>
    <style>
        /* –ê–ª–¥—ã“£“ì—ã –±–∞—Ä–ª—ã“õ —Å—Ç–∏–ª—å–¥–µ—Ä —Å–∞“õ—Ç–∞–ª–¥—ã */
        :root { --tg-blue: #24a1de; --tg-bg: #ffffff; --tg-sent: #effdde; --tg-gray: #8e8e93; --blur: saturate(180%) blur(20px); }
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; font-family: -apple-system, sans-serif; background: var(--tg-bg); overflow: hidden; }
        .auth-screen { position: fixed; inset: 0; z-index: 9999; background: linear-gradient(135deg, #24a1de, #0088cc); display: flex; align-items: center; justify-content: center; padding: 20px; }
        .auth-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: var(--blur); width: 100%; max-width: 380px; padding: 40px; border-radius: 30px; text-align: center; display: none; }
        .auth-card.active { display: block; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 15px; font-size: 16px; box-sizing: border-box; outline: none; background: #f5f5f5; }
        .btn { width: 100%; padding: 16px; background: var(--tg-blue); color: #fff; border: none; border-radius: 15px; font-weight: 600; cursor: pointer; margin-top: 15px; }
        .app { display: none; height: 100vh; flex-direction: column; }
        .header { height: 60px; padding: 0 16px; display: flex; align-items: center; border-bottom: 1px solid #eee; background: rgba(255,255,255,0.8); backdrop-filter: var(--blur); z-index: 100; }
        .search-box { flex: 1; margin-left: 15px; background: #f1f1f2; border-radius: 12px; display: flex; align-items: center; padding: 0 12px; }
        .search-box input { background: none; border: none; padding: 8px; margin: 0; width: 100%; }
        .chat-list { flex: 1; overflow-y: auto; background: #fff; }
        .chat-item { display: flex; align-items: center; padding: 12px 16px; cursor: pointer; border-bottom: 0.5px solid #f0f0f0; }
        .avatar { width: 54px; height: 54px; border-radius: 50%; background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 20px; flex-shrink: 0; position: relative; }
        .chat-view { position: fixed; inset: 0; background: #e7ecef; z-index: 500; display: none; flex-direction: column; }
        .chat-header { background: rgba(255,255,255,0.9); backdrop-filter: var(--blur); padding: 8px 16px; display: flex; align-items: center; border-bottom: 1px solid #ddd; }
        .message-container { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 15px; font-size: 15px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg.received { background: #fff; align-self: flex-start; }
        .msg.sent { background: var(--tg-sent); align-self: flex-end; }
        .input-area { background: #fff; padding: 10px 16px; display: flex; align-items: center; gap: 12px; border-top: 1px solid #eee; }
        .sidebar { position: fixed; left: -300px; top: 0; bottom: 0; width: 280px; background: #fff; z-index: 1000; transition: 0.3s; box-shadow: 20px 0 50px rgba(0,0,0,0.1); }
        .sidebar.active { left: 0; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 900; display: none; }
        .modal { position: fixed; inset: 0; background: #fff; z-index: 2000; display: none; padding: 25px; overflow-y: auto; }
        .mention { color: var(--tg-blue); cursor: pointer; font-weight: 500; }

        /* FAB STYLE */
        .fab { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; background: var(--tg-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: pointer; z-index: 800; }
        .fab-menu { position: fixed; bottom: 95px; right: 25px; display: none; flex-direction: column; gap: 10px; z-index: 800; }
        .fab-btn { background: white; color: var(--tg-blue); border: 1px solid var(--tg-blue); padding: 12px 20px; border-radius: 25px; font-weight: bold; cursor: pointer; box-shadow: var(--shadow); }
    </style>
</head>
<body>

<div class="auth-screen" id="auth-screen">
    <div class="auth-card active" id="card-welcome">
        <h2>Daugram Elite</h2>
        <button class="btn" onclick="showAuth('reg')">–ù–∞—á–∞—Ç—å –æ–±—â–µ–Ω–∏–µ</button>
        <button class="btn" style="background:none; color:var(--tg-blue)" onclick="showAuth('login')">–í–æ–π—Ç–∏</button>
    </div>
    <div class="auth-card" id="card-reg">
        <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
        <input type="text" id="reg-name" placeholder="–í–∞—à–µ –ò–º—è">
        <input type="text" id="reg-user" placeholder="–Æ–∑–µ—Ä–Ω–µ–π–º (–±–µ–∑ @)">
        <input type="email" id="reg-email" placeholder="Email">
        <input type="password" id="reg-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" onclick="handleRegister()">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    </div>
    <div class="auth-card" id="card-login">
        <h2>–í—Ö–æ–¥</h2>
        <input type="email" id="login-email" placeholder="Email">
        <input type="password" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" onclick="handleLogin()">–í–æ–π—Ç–∏</button>
    </div>
</div>

<div class="app" id="app">
    <div class="header">
        <div onclick="toggleSidebar(true)" style="cursor:pointer">‚ò∞</div>
        <div class="search-box"><input type="text" id="search" placeholder="–ü–æ–∏—Å–∫..." oninput="doSearch()"></div>
    </div>
    <div class="chat-list" id="chat-list"></div>
    <div class="fab-menu" id="fab-menu">
        <div class="fab-btn" onclick="openCreateModal('group')">üë• –ì—Ä—É–ø–ø–∞</div>
        <div class="fab-btn" onclick="openCreateModal('channel')">üì¢ –ö–∞–Ω–∞–ª</div>
    </div>
    <div class="fab" onclick="toggleFab()">+</div>
</div>

<div class="overlay" id="overlay" onclick="toggleSidebar(false)"></div>
<div class="sidebar" id="sidebar">
    <div style="background:var(--tg-blue); color:white; padding:30px 20px;">
        <div id="u-av" class="avatar"></div>
        <div id="u-name" style="font-weight:bold; margin-top:10px"></div>
        <div id="u-user" style="opacity:0.8"></div>
    </div>
    <div id="account-switcher"></div>
    <div style="padding:10px">
        <div class="chat-item" onclick="showAuth('welcome', true)">‚ûï –ê–∫–∫–∞—É–Ω—Ç</div>
        <div class="chat-item" onclick="logout()">üö™ –í—ã—Ö–æ–¥</div>
    </div>
</div>

<div class="chat-view" id="chat-view">
    <div class="chat-header">
        <span onclick="closeChat()" style="font-size:24px; cursor:pointer">‚Äπ</span>
        <div id="h-av" class="avatar" style="width:40px; height:40px; margin:0 12px; cursor:pointer" onclick="viewChatInfo()"></div>
        <div style="flex:1">
            <div id="h-name" style="font-weight:bold"></div>
            <div id="h-status" style="font-size:12px; color:var(--tg-blue)">–æ–Ω–ª–∞–π–Ω</div>
        </div>
    </div>
    <div class="message-container" id="msg-box"></div>
    <div class="input-area">
        <input type="text" id="m-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
        <div onclick="sendMessage()" style="color:var(--tg-blue); font-weight:bold; cursor:pointer">–û–¢–ü–†–ê–í–ò–¢–¨</div>
    </div>
</div>

<div class="modal" id="modal-info">
    <div id="v-av" class="avatar" style="width:120px; height:120px; margin:20px auto"></div>
    <h2 id="v-name" style="text-align:center"></h2>
    <p id="v-user" style="text-align:center; color:var(--tg-blue)"></p>
    <div id="v-extra" style="background:#f5f5f5; padding:15px; border-radius:15px; margin:15px 0"></div>
    <div id="admin-tools"></div>
    <button class="btn" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
</div>

<script>
    let users = JSON.parse(localStorage.getItem('dg_users')) || [];
    let rooms = JSON.parse(localStorage.getItem('dg_rooms')) || []; // –ì—Ä—É–ø–ø—ã –∏ –∫–∞–Ω–∞–ª—ã
    let curIdx = parseInt(localStorage.getItem('dg_cur_idx')) || 0;

    if(users.length > 0) initApp();

    function saveData() {
        localStorage.setItem('dg_users', JSON.stringify(users));
        localStorage.setItem('dg_rooms', JSON.stringify(rooms));
        localStorage.setItem('dg_cur_idx', curIdx);
    }

    function showAuth(c, add=false) {
        document.querySelectorAll('.auth-card').forEach(x => x.classList.remove('active'));
        document.getElementById('card-'+c).classList.add('active');
        document.getElementById('auth-screen').style.display = 'flex';
        if(!add) document.getElementById('app').style.display = 'none';
    }

    function handleRegister() {
        const name = document.getElementById('reg-name').value;
        const user = document.getElementById('reg-user').value.toLowerCase().trim();
        const email = document.getElementById('reg-email').value;
        const pass = document.getElementById('reg-pass').value;
        if(!name || !user) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!');
        const newUser = { name, user, email, pass, av: '', chats: [] };
        users.push(newUser);
        curIdx = users.length - 1;
        saveData(); initApp();
    }

    function handleLogin() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        const idx = users.findIndex(u => u.email === email && u.pass === pass);
        if(idx === -1) return alert('–û—à–∏–±–∫–∞!');
        curIdx = idx; saveData(); initApp();
    }

    function initApp() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('app').style.display = 'flex';
        updateSidebar(); renderChats();
    }

    function toggleFab() { const m = document.getElementById('fab-menu'); m.style.display = m.style.display === 'flex' ? 'none' : 'flex'; }

    function openCreateModal(type) {
        const name = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ ' + (type === 'group' ? '–≥—Ä—É–ø–ø—ã' : '–∫–∞–Ω–∞–ª–∞'));
        const user = prompt('–í–≤–µ–¥–∏—Ç–µ —é–∑–µ—Ä–Ω–µ–π–º (ID)');
        if(!name || !user) return;
        const newRoom = { id: user, name, type, owner: users[curIdx].user, admins: [], members: [users[curIdx].user], msgs: [] };
        rooms.push(newRoom);
        saveData(); renderChats(); toggleFab();
    }

    function renderChats() {
        const box = document.getElementById('chat-list'); box.innerHTML = '';
        const me = users[curIdx];
        
        // –õ–∏—á–Ω—ã–µ —á–∞—Ç—ã + –ì—Ä—É–ø–ø—ã/–ö–∞–Ω–∞–ª—ã, –≤ –∫–æ—Ç–æ—Ä—ã—Ö —Å–æ—Å—Ç–æ–∏—Ç —é–∑–µ—Ä
        const myRooms = rooms.filter(r => r.members.includes(me.user));
        const all = [...me.chats, ...myRooms];

        all.forEach(c => {
            box.innerHTML += `
                <div class="chat-item" onclick="openChat('${c.id}')">
                    <div class="avatar" style="background-color:#24a1de">${c.name[0]}</div>
                    <div style="margin-left:15px">
                        <b>${c.name}</b><br>
                        <small style="color:gray">${c.type ? (c.type==='group'?'–ì—Ä—É–ø–ø–∞':'–ö–∞–Ω–∞–ª') : '@'+c.id}</small>
                    </div>
                </div>`;
        });
    }

    let activeId = null;
    function openChat(id) {
        activeId = id;
        const me = users[curIdx];
        const chat = rooms.find(r => r.id === id) || me.chats.find(c => c.id === id) || users.find(u => u.user === id);
        
        document.getElementById('chat-view').style.display = 'flex';
        document.getElementById('h-name').innerText = chat.name || chat.user;
        document.getElementById('h-av').innerText = (chat.name || chat.user)[0];
        document.getElementById('h-status').innerText = chat.type ? (chat.type==='group'?'—Å–æ–æ–±—â–µ—Å—Ç–≤–æ':'—Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è') : '–≤ —Å–µ—Ç–∏';
        renderMessages();
    }

    function sendMessage() {
        const text = document.getElementById('m-input').value.trim();
        if(!text) return;
        const me = users[curIdx];
        const room = rooms.find(r => r.id === activeId);

        if(room) {
            if(room.type === 'channel' && room.owner !== me.user && !room.admins.includes(me.user)) {
                return alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –≤ –∫–∞–Ω–∞–ª!');
            }
            room.msgs.push({ t: text, sender: me.user, senderName: me.name, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
        } else {
            // –õ–∏—á–∫–∞ (–õ–æ–≥–∏–∫–∞ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∫–æ–¥–∞)
            let myChat = me.chats.find(c => c.id === activeId);
            if(!myChat) {
                const other = users.find(u => u.user === activeId);
                myChat = { id: other.user, name: other.name, msgs: [] };
                me.chats.push(myChat);
            }
            myChat.msgs.push({ t: text, my: true, time: '12:00' });
        }

        document.getElementById('m-input').value = '';
        saveData(); renderMessages();
    }

    function renderMessages() {
        const box = document.getElementById('msg-box'); box.innerHTML = '';
        const me = users[curIdx];
        const room = rooms.find(r => r.id === activeId);

        if(room) {
            room.msgs.forEach(m => {
                const isMy = m.sender === me.user;
                box.innerHTML += `
                    <div class="msg ${isMy?'sent':'received'}">
                        ${room.type==='group' && !isMy ? `<small style="color:var(--tg-blue); font-weight:bold" onclick="openUserProfile('${m.sender}')">${m.senderName}</small><br>` : ''}
                        ${m.t}
                    </div>`;
            });
        }
        box.scrollTop = box.scrollHeight;
    }

    function viewChatInfo() {
        const room = rooms.find(r => r.id === activeId);
        const modal = document.getElementById('modal-info');
        const extra = document.getElementById('v-extra');
        const adminTools = document.getElementById('admin-tools');
        adminTools.innerHTML = '';

        if(room) {
            document.getElementById('v-name').innerText = room.name;
            document.getElementById('v-user').innerText = 'd.me/' + room.id;
            extra.innerHTML = `
                <b>–í–ª–∞–¥–µ–ª–µ—Ü:</b> @${room.owner}<br>
                <b>–¢–∏–ø:</b> ${room.type === 'group' ? '–ì—Ä—É–ø–ø–∞' : '–ö–∞–Ω–∞–ª'}<br>
                <b>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</b> ${room.members.length}`;
            modal.style.display = 'block';
        } else {
            openUserProfile(activeId);
        }
    }

    function openUserProfile(userId) {
        const user = users.find(u => u.user === userId);
        const room = rooms.find(r => r.id === activeId);
        const me = users[curIdx];
        
        document.getElementById('v-name').innerText = user.name;
        document.getElementById('v-user').innerText = '@' + user.user;
        document.getElementById('v-extra').innerText = '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ';
        
        const tools = document.getElementById('admin-tools');
        tools.innerHTML = '';
        
        // –ê–¥–º–∏–Ω –±–∞—Ç—ã—Ä–º–∞—Å—ã (—Ç–µ–∫ –ì—Ä—É–ø–ø–∞ –∏–µ—Å—ñ–Ω–µ –∫”©—Ä—ñ–Ω–µ–¥—ñ)
        if(room && room.owner === me.user && user.user !== me.user) {
            const isAdmin = room.admins.includes(user.user);
            tools.innerHTML = `<button class="btn" style="background:orange" onclick="toggleAdmin('${user.user}')">
                ${isAdmin ? '–†–∞–∑–∂–∞–ª–æ–≤–∞—Ç—å' : '–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º'}
            </button>`;
        }

        document.getElementById('modal-info').style.display = 'block';
    }

    function toggleAdmin(userId) {
        const room = rooms.find(r => r.id === activeId);
        if(room.admins.includes(userId)) {
            room.admins = room.admins.filter(a => a !== userId);
        } else {
            room.admins.push(userId);
        }
        saveData();
        alert('–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω!');
        closeModal();
    }

    function handleLink(link) {
        const target = link.replace('d.me/', '').replace('@', '');
        const room = rooms.find(r => r.id === target);
        if(room) {
            if(!room.members.includes(users[curIdx].user)) {
                if(confirm('–•–æ—Ç–∏—Ç–µ –≤—Å—Ç—É–ø–∏—Ç—å –≤ ' + room.name + '?')) {
                    room.members.push(users[curIdx].user);
                    saveData();
                } else return;
            }
            openChat(target);
        }
    }

    function doSearch() {
        const q = document.getElementById('search').value.toLowerCase();
        if(q.includes('d.me/')) return handleLink(q);
        renderChats();
    }

    function toggleSidebar(s) { document.getElementById('sidebar').classList.toggle('active', s); document.getElementById('overlay').style.display = s?'block':'none'; }
    function closeChat() { document.getElementById('chat-view').style.display = 'none'; }
    function closeModal() { document.getElementById('modal-info').style.display = 'none'; }
    function updateSidebar() {
        const me = users[curIdx];
        document.getElementById('u-name').innerText = me.name;
        document.getElementById('u-user').innerText = '@' + me.user;
        document.getElementById('u-av').innerText = me.name[0];
    }
    function logout() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
